name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: ðŸ” Lint Code
    uses: ./.github/workflows/lint.yml

  test:
    name: ðŸ§ª Run Tests
    uses: ./.github/workflows/test.yml

  build:
    name: ðŸ—ï¸ Build Application
    needs: [lint, test]
    uses: ./.github/workflows/build.yml

  ci-summary:
    name: ðŸ“‹ CI Summary
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          echo "## ðŸ“Š CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Lint | ${{ needs.lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Test | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Build | ${{ needs.build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.lint.result }}" == "success" && "${{ needs.test.result }}" == "success" && "${{ needs.build.result }}" == "success" ]]; then
            echo "ðŸŽ‰ All checks passed! Ready to merge." >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "âŒ Some checks failed. Please review and fix the issues." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  deploy-preview:
    name: ðŸš€ Deploy Preview
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    if: github.event_name == 'pull_request' && needs.lint.result == 'success' && needs.test.result == 'success' && needs.build.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4  # TambiÃ©n actualiza esto a v4
        with:
          name: dist-${{ github.sha }}
          path: dist/

      - name: Deploy to preview
        run: |
          echo "ðŸš€ Deploying preview for PR #${{ github.event.number }}"
          echo "Preview would be available at: https://preview-${{ github.event.number }}.your-domain.com"
          # AquÃ­ irÃ­an los pasos reales de deployment